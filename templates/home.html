{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block sidebar %}
<!-- code for city with pincodes -->
{% if markets %} 
<div class="relative mb-6 pt-4 p-2">
  <button onclick="document.getElementById('dropdown').classList.toggle('hidden')" class="bg-white text-black text-xl font-semibold px-4 py-2 rounded w-full text-left">
    Select Markets
  </button>
  <!-- <div id="dropdown" class="hidden absolute z-10 w-full bg-white border rounded shadow mt-1 max-h-96 overflow-y-auto"> -->
  <div id="dropdown" class=" relative hidden absolute z-10 w-full pr-4 py-2  rounded shadow mt-1 max-h-96  bg-black  overflow-y-auto scrollbar-thin scrollbar-width:10px scrollbar-border-radius:5px scrollbar-thumb-gray-500 scrollbar-track-gray-200">   
    <input type="text" id="searchInput" placeholder="Search state..." class="w-full  border-gray-600 p-2  border-b" onkeyup="filterStates()">
    <div id="stateList">
      {% for state, cities in markets.items() %}
      <div class="state-group" data-state="{{ state }}">
        <label class="block bg-black px-2 py-1 text-white font-semibold">
          <input type="checkbox" name="state" value="{{ state }}" class="state-checkbox" data-state="{{ state }}" {% if state.checked %}checked{% endif %}> {{ state }}
        </label>
        <div class="city-container pl-4 hidden max-h-40 overflow-y-auto scrollbar-thin scrollbar-width:6px  scrollbar-thumb-gray-500 scrollbar-track-gray-200" data-parent-state="{{ state }}">
          {% for city, pincodes in cities.items() %}
          <div class="city-group" data-city="{{ city }}">
            <label class="block  text-white text-sm font-medium">
              <input type="checkbox" name="city" value="{{ city }}" class="city-checkbox" data-city="{{ city }}" {% if city.checked %}checked{% endif %}> {{ city }}
            </label>
            <div class="pincode-container pl-4 hidden max-h-40 overflow-y-auto scrollbar-thin scrollbar-width:10px scrollbar-border-radius:5px scrollbar-thumb-gray-500 scrollbar-track-gray-200 " data-parent-city="{{ city }}">
              <label class="block text-white text-sm font-medium ">
                <input type="checkbox" class="select-all-pincode" data-city="{{ city }}"> Select All
              </label>
              {% for pin in pincodes %}
              <label class="block   text-white text-sm font-medium">
                <input type="checkbox" name="pincode" value="{{ pin }}" data-city="{{ city }}" {% if pin.checked %}checked{% endif %}> {{ pin }}
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<script>
  function filterStates() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.state-group').forEach(group => {
      const state = group.getAttribute('data-state').toLowerCase();
      group.style.display = state.includes(input) ? 'block' : 'none';
    });
  }

  function toggleCityVisibility() {
    document.querySelectorAll('.state-checkbox').forEach(stateCb => {
      const state = stateCb.getAttribute('data-state');
      const cityContainer = document.querySelector(`.city-container[data-parent-state="${state}"]`);
      if (stateCb.checked) {
        cityContainer.classList.remove('hidden');
      } else {
        cityContainer.classList.add('hidden');
        cityContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    });
  }

  function togglePincodeVisibility() {
    document.querySelectorAll('.city-checkbox').forEach(cityCb => {
      const city = cityCb.getAttribute('data-city');
      const pinContainer = document.querySelector(`.pincode-container[data-parent-city="${city}"]`);
      if (cityCb.checked) {
        pinContainer.classList.remove('hidden');
      } else {
        pinContainer.classList.add('hidden');
        pinContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    });
  }

  function handleSelectAllPincodes() {
    document.querySelectorAll('.select-all-pincode').forEach(selectAll => {
      selectAll.addEventListener('change', () => {
        const city = selectAll.getAttribute('data-city');
        const checkboxes = document.querySelectorAll(`input[name="pincode"][data-city="${city}"]`);
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateSession();
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.state-checkbox').forEach(cb => {
      cb.addEventListener('change', () => {
        toggleCityVisibility();
        updateSession();
      });
    });

    document.querySelectorAll('.city-checkbox').forEach(cb => {
      cb.addEventListener('change', () => {
        togglePincodeVisibility();
        updateSession();
      });
    });
    handleSelectAllPincodes();
  });
</script>
{% endblock %} 
{% block content %}
<div>     
  {% if features %} 
  <div class=" container p-2 mb-4  rounded-lg shadow-md">
    <h2 class="text-xl font-semibold p-2 mb-4">Features:</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border border-gray-300">
        <thead class="bg-black text-white">
          <tr>
            {% for category in features.keys() %}
              <th class="px-4 py-2 text-left">{{ category }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% set max_rows = features.values() | map('length') | max %}
          {% for i in range(max_rows) %}
            <tr>
              {% for category, items in features.items() %}
                <td class="px-4 py-2">
                  {% if i < items|length %}
                    <label class="flex items-center space-x-2">
                      <input type="checkbox"name="feature" 
                        value="{{ items[i].variable }}" class="form-checkbox text-gray-400"
                        {% if items[i].checked %}checked{% endif %}>
                      <span>{{ items[i].name }}</span>
                    </label>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>       
    
  {% else %}
      <p>No features available.</p>
  {% endif %}
</div>
{% endblock %}

  
  

